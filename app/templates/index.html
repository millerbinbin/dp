<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type="text/css">
		html, body, #map {width: 100%;height: 100%;}
	</style>
  <style>
    .div-relative{position:relative;width:100%;height:100%}
    .div-a{ position:absolute;left:0%;top:6%;z-index:100;width:45%;height:50%}
    .div-b{ position:absolute;z-index:80;width:100%;height:100%}
   </style>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=kAWXbccRXNNwQl79u9cFcV6eysiBiBeA"></script>
	<script type="text/javascript" src="../static/js/jquery-3.2.1.min.js"></script>
  <link href="../static/css/bootstrap.css" rel="stylesheet">
  <link href="../static/css/skins/polaris/polaris.css" rel="stylesheet">
	<script type="text/javascript" src="../static/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="../static/js/icheck.js"></script>
	<title>精品推荐</title>
	<link rel="shortcut icon" href="../static/image/dp.jpg" >
</head>
<body>
<div class="container">
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-9" aria-expanded="false">-->
          <!--<span class="sr-only">Toggle navigation</span>-->
          <!--<span class="icon-bar"></span>-->
          <!--<span class="icon-bar"></span>-->
          <!--<span class="icon-bar"></span>-->
        <!--</button>-->
        <div class="navbar-brand" >
          <a href="#" onclick="filter_hidden(false)">
            <span class="glyphicon glyphicon-filter"></span>筛选<span class="caret"></span>
          </a>
        </div>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-center">
          <li id="taste_tab" value="taste_score" onclick="order_by(this)" class="active"><a href="#">口味优先</a></li>
          <li id="comment_tab" value="comment_num" onclick="order_by(this)"><a href="#">最热讨论</a></li>
          <li id="heat_tab" value="weighted_hits" onclick="order_by(this)"><a href="#">点击为王</a></li>
          <li id="rating_tab" value="good_rate" onclick="order_by(this)"><a href="#">好评如潮</a></li>
          <li id="distance_tab" value="verse_taxi_distance" onclick="order_by(this)"><a href="#">周边美食</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">

          <li><a href="#" onclick="refresh_data(true)">
            <span class="glyphicon glyphicon-refresh"></span>换一批
          </a></li>
        </ul>
      </div>
    </div>
  </nav>
</div>
<div class="div-relative">
  <div class="panel hidden div-a" id="filter_box">
    <div class="panel-body" id="category-selection">
      <label>菜系选择</label>
      <div class="checkbox">
        <label><input type="checkbox" aria-label="本帮江浙菜">本帮江浙菜</label>
        <label><input type="checkbox" aria-label="日本菜">日本菜</label>
        <label><input type="checkbox" aria-label="咖啡厅">咖啡厅</label>
        <label><input type="checkbox" aria-label="小吃快餐">小吃快餐</label>
        <label><input type="checkbox" aria-label="火锅">火锅&emsp;</label>
        <label><input type="checkbox" aria-label="西餐">西餐</label>
      </div>
      <div class="checkbox">
        <label><input type="checkbox" aria-label="面包甜点">面包甜点&emsp;</label>
        <label><input type="checkbox" aria-label="自助餐">自助餐</label>
        <label><input type="checkbox" aria-label="粤菜">粤菜&emsp;</label>
        <label><input type="checkbox" aria-label="韩国料理">韩国料理</label>
        <label><input type="checkbox" aria-label="小龙虾">小龙虾</label>
        <label><input type="checkbox" aria-label="烧烤">烧烤</label>
      </div>
      <div class="checkbox">
        <label><input type="checkbox" aria-label="川菜">川菜&emsp;&emsp;&emsp;</label>
        <label><input type="checkbox" aria-label="素菜">素菜&emsp;</label>
        <label><input type="checkbox" aria-label="东北菜">东北菜</label>
        <label><input type="checkbox" aria-label="东南亚菜">东南亚菜</label>
        <label><input type="checkbox" aria-label="湘菜">湘菜&emsp;</label>
        <label><input type="checkbox" aria-label="云南菜">云南菜</label>
      </div>
      <div class="checkbox">
        <label><input type="checkbox" aria-label="新疆菜">新疆菜&emsp;&emsp;</label>
        <label><input type="checkbox" aria-label="海鲜">海鲜&emsp;</label>
        <label><input type="checkbox" aria-label="西北菜">西北菜</label>
        <label><input type="checkbox" aria-label="蟹宴">蟹宴&emsp;&emsp;</label>
        <label><input type="checkbox" aria-label="台湾菜">台湾菜</label>
        <label><input type="checkbox" aria-label="贵州菜">贵州菜</label>
      </div>
      <div class="checkbox">
        <label><input type="checkbox" aria-label="面馆">面馆&emsp;&emsp;&emsp;</label>
        <label><input type="checkbox" aria-label="家常菜">家常菜</label>
        <label><input type="checkbox" aria-label="江西菜">江西菜</label>
        <label><input type="checkbox" aria-label="其他">其他</label>
      </div>
      <br>
      <div class="row">
        <form class="form-inline col-md-4">
          <label class="form-label">评分不低于:</label>
          <input class="form-control input-sm" type="number" style="width:40%;" id="taste-score">
        </form>
        <form class="form-inline col-md-4">
            <label class="form-label">人均:</label>
            <input class="form-control input-sm" type="number" style="width:30%;" id="avg-price-min">
            <label class="form-label">--</label>
            <input class="form-control input-sm" type="number" style="width:30%;" id="avg-price-max">
        </form>
        <form class="form-inline col-md-4">
            <label class="form-label">评论数不少于:</label>
            <input class="form-control input-sm" type="number" style="width:40%;" id="comment-num">
        </form>
      </div>
      <br><br>
      <div class="row">
        <div class="col-md-4"></div>
        <button class="btn btn-primary col-md-2" onclick="filter_hidden(true)" >确定</button>
      </div>
    </div>
  </div>
  <div id="map" class="container div-b"></div>
</div>
<script type="text/javascript">
  $(document).ready(function(){
    $('input').iCheck({
      checkboxClass: 'icheckbox_polaris',
      radioClass: 'iradio_polaris',
      increaseArea: '-10%' // optional
    });
  });

  var map_center = {"lat":31.236923, "lng": 121.483644};
  var map_layer = 13;
  var current_page = 1;
  var limit_num = 40;
  var order_col = "taste_score";
  var category_set = new Set();
  var taste_score;
  var avg_price_min;
  var avg_price_max;
  var comment_num;
  init_data();

  function bind_category_checkbox(){
    $('#category-selection').find("input[type=checkbox]").each(function(){
      $(this).on('ifChecked', function(event){
        category_name = $(this).attr("aria-label")
        category_set.add(category_name);
        console.log(category_set);
      });
      $(this).on('ifUnchecked', function(event){
        category_name = $(this).attr("aria-label")
        category_set.delete(category_name);
      });
    });
  }
  function filter_hidden(refresh){
    ($("#filter_box").attr("class").indexOf("hidden")>=0)?hidden=false:hidden=true;
    if (hidden == false){
      $("#filter_box").removeClass("hidden");
    }else{
      $("#filter_box").addClass("hidden");
    }
    taste_score = parseFloat($("#taste-score").val());
    if (isNaN(taste_score)){taste_score = undefined;}
    avg_price_min = parseInt($("#avg-price-min").val());
    if (isNaN(avg_price_min)){avg_price_min = undefined;}
    avg_price_max = parseInt($("#avg-price-max").val());
    if (isNaN(avg_price_max)){avg_price_max = undefined;}
    comment_num = parseInt($("#comment-num").val());
    if (isNaN(comment_num)){comment_num = undefined;}
    if (refresh === true){
      refresh_data(false);
    }
  }
  function init_data(){
    map = init_map();
    bind_category_checkbox();
    render_data(get_data(current_page, limit_num, "taste_score"));
  }
  function refresh_data(page_down){
    if (page_down) {current_page+=1};
    data = get_data(current_page, limit_num, order_col)
    render_data(data);
  }
  function order_by(which){
    $("#taste_tab").removeClass("active");
    $("#comment_tab").removeClass("active");
    $("#heat_tab").removeClass("active");
    $("#rating_tab").removeClass("active");
    $("#distance_tab").removeClass("active");
    $(which).addClass("active");
    order_col = $(which).attr("value");
    current_page = 1;
    refresh_data(false);
  }

  function init_map(){
    var map = new BMap.Map("map");
    var point = new BMap.Point(map_center.lng, map_center.lat);
    map.centerAndZoom(point, map_layer);
    map.enableScrollWheelZoom(true);
    return map;
  }

  function get_data(page, top, order_by){
    var param = {"taste_score": taste_score, "comment_num": comment_num, "avg_price_min": avg_price_min, "avg_price_max": avg_price_max};
    var category_str = "";
    category_set.forEach(function (item) {
      category_str+=item.toString() + ",";
    });
    param.category = category_str;
    console.log(param);
    $.ajax({
       url: '/shops/'+page+'/'+top+'/order_by='+order_by,
       dataType: 'json',
       type: 'POST',
       data: param,
       timeout: 2000,
       cache: false,
       crossDomain: true,
       async : false,
       error: function(){alert("get data error!");},
       success: function(data){result = data;}
    });
    return result;
  }

  function render_data(data_info){
    map.clearOverlays();
    for(var i=0;i<data_info.length;i++){
      var marker = new BMap.Marker(new BMap.Point(data_info[i].lng,data_info[i].lat));  // 创建标注
      var shop_link = 'http://www.dianping.com/shop/' + data_info[i].shop_id;
      var detail = '<div class="row"><div class="col-xs-8"><a class="text-left" target="_blank" href="'+shop_link+'"><h5>'+data_info[i].name+'</h5></a></div></div>' +
      '<div>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;\
            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</div>' +
      '<div class="row"><div class="col-xs-4"><span class="label label-default">菜&emsp;系：'+data_info[i].category+'</span></div>' +
      '<div class="col-xs-4"><span class="label label-warning">口&emsp;味：'+data_info[i].taste_score+'</span></div>' +
      '<div class="col-xs-4"><span class="label label-success">人&emsp;均：¥'+data_info[i].avg_price+'</span></div></div>' +
      '<div class="row"><div class="col-xs-4"><span class="label label-info">评论数：'+data_info[i].comment_num+'</span></div>' +
      '<div class="col-xs-4"><span class="label label-danger">好评率：'+data_info[i].good_rate+'%</span></div>' +
      '<div class="col-xs-4"></div></div><br>' +
      '<span class="label label-primary">行程耗时：'+data_info[i].public_duration+'</span>'+
      '<div><span class="label label-primary">'+data_info[i].route+'</span></div>';
      map.addOverlay(marker);               // 将标注添加到地图中
      addClickHandler(detail,marker);
    }
    if (data_info.length < limit_num){
      current_page = 1
    }
  }
  function addClickHandler(detail,marker){
    marker.addEventListener("click",function(e){
      openDetailInfo(detail, e)}
    );
  }
  function openDetailInfo(detailInfo, e){
    var p = e.target;
    var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
    var option = {};
    var infoWindow = new BMap.InfoWindow(detailInfo, option);  // 创建信息窗口对象
    map.openInfoWindow(infoWindow,point); //开启信息窗
    //infoWindow.redraw();
  }
</script>
</body>
</html>